{% extends "layout.html" %}

{% block content %}

<div class="container my-5">
    <style>
        .history-stat-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer; /* è®“é …ç›®çœ‹èµ·ä¾†å¯ä»¥é»æ“Š */
            transition: background-color 0.2s;
        }

            .history-stat-item:hover {
                background-color: #e9ecef;
            }

        .answer-text {
            color: #198754; /* Bootstrap success green */
            font-weight: bold;
        }

        .modal-question-info p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .tag-badge {
            display: inline-block;
            padding: .35em .65em;
            margin-right: 5px;
            font-size: .75em;
            font-weight: 700;
            line-height: 1;
            color: #fff;
            background-color: #0d6efd; /* Blue */
            border-radius: .25rem;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
        }
        /* LLM å›æ‡‰å€ */
        #llm-explanation {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin-top: 15px;
            background-color: #e9f7ff;
            border-radius: 4px;
        }
        /* çŸ¥è­˜åœ–è­œå°ˆå±¬æ¨£å¼ */
        .graph-container {
            width: 100%;
            height: 85vh; /* ä½”æ“šå¤§éƒ¨åˆ†å¯è¦–é«˜åº¦ */
            border: 1px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .node {
            stroke: #fff;
            stroke-width: 1.5px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .tooltip {
            position: absolute;
            padding: 8px;
            font: 12px sans-serif;
            background: #333;
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            word-wrap: break-word;
            text-align: left;
            line-height: 1.4;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            font-size: 14px; /* èª¿æ•´å­—é«”å¤§å° */
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        /* ç¯€é»é¡è‰²å®šç¾© */
        .group-question {
            fill: #4E79A7;
        }
        /* é¡Œç›®: è—è‰² */
        .group-tag {
            fill: #F28E2B;
        }
        /* æ¨™ç±¤: æ©˜è‰² */
        .group-book {
            fill: #59A14F;
        }
        /* ä¾†æºæ›¸ç±: ç¶ è‰² */
    </style>

    <div class="container-fluid my-4">
        <h1 class="text-center mb-3 text-primary">ğŸ“š çŸ¥è­˜åœ–è­œè¦–è¦ºåŒ–</h1>
        <p class="text-center text-muted">æœ¬åœ–è­œé¡¯ç¤ºé¡Œç›®ã€æ¨™ç±¤åŠä¾†æºæ›¸ç±ä¹‹é–“çš„é—œè¯ã€‚ç¯€é»å¤§å°ä»£è¡¨é‡è¦æ€§ (é¡Œç›®ç¯€é»å¤§å°èˆ‡**éŒ¯èª¤æ¬¡æ•¸**ç›¸é—œ)ã€‚</p>

        <!-- åœ–ä¾‹å€ -->
        <div class="d-flex justify-content-center mb-3 flex-wrap">
            <div class="legend-item"><div class="legend-dot group-book"></div> ä¾†æºæ›¸ç± (å¤§)</div>
            <div class="legend-item"><div class="legend-dot group-tag"></div> æ¨™ç±¤ (ä¸­)</div>
            <div class="legend-item"><div class="legend-dot group-question"></div> é¡Œç›® (å°ï¼Œéš¨éŒ¯èª¤æ¬¡æ•¸è®Šå¤§)</div>
        </div>

        <!-- çŸ¥è­˜åœ–è­œå®¹å™¨ -->
        <div id="loading-spinner" class="text-center my-5">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">è¼‰å…¥ä¸­...</span></div>
            <p class="mt-2 text-muted">æ­£åœ¨ç”ŸæˆçŸ¥è­˜åœ–è­œ...</p>
        </div>

        <div class="graph-container">
            <!-- SVG å°‡åœ¨æ­¤è™•ç”Ÿæˆ -->
        </div>
    </div>

    <!-- å¼•å…¥ D3.js åº« -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // çŸ¥è­˜åœ–è­œè…³æœ¬
        async function loadKnowledgeGraph() {
            const spinner = document.getElementById('loading-spinner');
            const container = document.querySelector('.graph-container');
            container.innerHTML = '';
            spinner.style.display = 'block';

            // é‡æ–°ç²å–å®¹å™¨çš„å¯¬é«˜ (é‡è¦ï¼Œç¢ºä¿éŸ¿æ‡‰å¼)
            const width = container.clientWidth;
            const height = container.clientHeight;

            if (width === 0 || height === 0) {
                console.warn("Graph container is not visible or has zero dimensions. Retrying in 500ms.");
                setTimeout(loadKnowledgeGraph, 500);
                return;
            }

            try {
                // âœ… ç¢ºä¿é€™è£¡å‘¼å«çš„ API è·¯ç”±æ˜¯ /api/knowledge_graph
                const response = await fetch('/api/knowledge_graph');

                let graph;
                if (!response.ok) {
                    // å˜—è©¦è§£æéŒ¯èª¤è¨Šæ¯ï¼Œå¦‚æœå¤±æ•—å‰‡æ‹‹å‡ºæ¨™æº–éŒ¯èª¤
                    const errorText = await response.text();
                    throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ ${response.status}: ${errorText.substring(0, 50)}...`);
                }
                graph = await response.json();


                // ç¢ºä¿ç¯€é»å’Œé€£çµå­˜åœ¨
                if (!graph.nodes || graph.nodes.length === 0) {
                    container.innerHTML = '<p class="text-center p-5 text-muted">ç„¡çŸ¥è­˜åœ–è­œæ•¸æ“šå¯é¡¯ç¤ºã€‚</p>';
                    return;
                }

                // åŸ·è¡Œç¹ªåœ–
                drawGraph(graph, width, height);

            } catch (error) {
                console.error("è¼‰å…¥çŸ¥è­˜åœ–è­œå¤±æ•—:", error);
                container.innerHTML = `<p class="text-center p-5 text-danger">éŒ¯èª¤ï¼š${error.message}</p>`;
            } finally {
                spinner.style.display = 'none';
            }
        }

        function drawGraph(graph, width, height) {

            // æ¸…é™¤èˆŠçš„ SVG
            d3.select(".graph-container svg").remove();

            // å»ºç«‹ SVG å®¹å™¨
            const svg = d3.select(".graph-container")
                .append("svg")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("width", width)
                .attr("height", height);

            // æ·»åŠ çµ„å…ƒç´ ç”¨æ–¼å¹³ç§»å’Œç¸®æ”¾
            const g = svg.append("g");

            // å•Ÿå‹• Zoom è¡Œç‚º
            svg.call(d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", function ({ transform }) {
                    g.attr("transform", transform);
                }))
                .on("dblclick.zoom", null); // ç¦ç”¨é›™æ“Šç¸®æ”¾

            // å®šç¾©ç¯€é»é¡è‰² (èˆ‡ CSS å®šç¾©çš„é¡è‰²ä¿æŒä¸€è‡´)
            const color = d3.scaleOrdinal()
                .domain(["question", "tag", "book"])
                .range(["#4E79A7", "#F28E2B", "#59A14F"]);

            // å®šç¾©åŠ›å°å‘æ¨¡æ“¬
            const simulation = d3.forceSimulation(graph.nodes)
                .force("link", d3.forceLink(graph.links).id(d => d.id).distance(100).strength(d => d.value * 0.1))
                .force("charge", d3.forceManyBody().strength(-1000)) // ç¯€é»é–“æ’æ–¥åŠ›
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(d => d.size * 2)); // é¿å…é‡ç–Š

            // ç¹ªè£½é€£çµ (Links)
            const link = g.append("g")
                .attr("class", "links")
                .attr("stroke", "#999")
                .selectAll("line")
                .data(graph.links)
                .enter().append("line")
                .attr("class", "link")
                .attr("stroke-width", d => Math.sqrt(d.value) * 1.5);

            // ç¹ªè£½ç¯€é» (Nodes)
            const node = g.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(graph.nodes)
                .enter().append("circle")
                .attr("class", d => `node group-${d.group}`)
                .attr("r", d => d.size)
                .attr("fill", d => color(d.type))
                .call(drag(simulation));

            // ç¹ªè£½æ¨™ç±¤ (Labels)
            const label = g.append("g")
                .attr("class", "labels")
                .selectAll("text")
                .data(graph.nodes)
                .enter().append("text")
                .attr("x", d => d.size + 2) // ç¨å¾®åç§»åœ“åœˆ
                .attr("y", 3)
                .text(d => d.name)
                .style("font-size", d => d.type === 'book' ? '14px' : '10px')
                .style("fill", "#333")
                .style("pointer-events", "none"); // ç¢ºä¿æ¨™ç±¤ä¸æœƒé˜»æ“‹é»æ“Š

            // ç¹ªè£½æµ®å‹•æç¤º (Tooltip)
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip");

            // æ·»åŠ äº’å‹•äº‹ä»¶
            node.on("mouseover", function (event, d) {
                // é¡¯ç¤º tooltip (é¡¯ç¤ºå®Œæ•´çš„ nameï¼Œå› ç‚ºç¯€é»ä¸Šå¯èƒ½è¢«æˆªæ–·äº†)
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                // ç”±æ–¼æˆ‘å€‘åœ¨å¾Œç«¯å° name é€²è¡Œäº†æˆªæ–·ï¼Œé€™è£¡åªèƒ½é¡¯ç¤ºæˆªæ–·å¾Œçš„ name
                let tooltipContent = `<strong>${d.name}</strong>`;
                if (d.type === 'question' && d.error_count) {
                    tooltipContent += `<br>éŒ¯èª¤æ¬¡æ•¸: ${d.error_count}`;
                }
                tooltip.html(tooltipContent)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");

                // çªå‡ºé¡¯ç¤ºç›¸é„°ç¯€é»
                const connectedNodes = getConnectedNodes(d, graph.links);
                node.style("opacity", n => connectedNodes.includes(n.id) || n.id === d.id ? 1 : 0.1);
                link.style("stroke-opacity", l => l.source.id === d.id || l.target.id === d.id ? 1 : 0.1)
                    .style("stroke", l => l.source.id === d.id || l.target.id === d.id ? "#333" : "#999");
                label.style("opacity", n => connectedNodes.includes(n.id) || n.id === d.id ? 1 : 0.1);

            }).on("mouseout", function (d) {
                // éš±è— tooltip ä¸¦æ¢å¾©æ‰€æœ‰ç¯€é»
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                node.style("opacity", 1);
                link.style("stroke-opacity", 0.6).style("stroke", "#999");
                label.style("opacity", 1);
            });

            // æ¨¡æ“¬çš„ Tick å‡½æ•¸ï¼šæ›´æ–°ç¯€é»å’Œé€£çµä½ç½®
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                // é™åˆ¶ç¯€é»é‚Šç•Œ
                node
                    .attr("cx", d => d.x = Math.max(d.size, Math.min(width - d.size, d.x)))
                    .attr("cy", d => d.y = Math.max(d.size, Math.min(height - d.size, d.y)));

                label
                    .attr("x", d => d.x + d.size + 2)
                    .attr("y", d => d.y + 3);
            });
        }

        // æ‹–æ›³è™•ç†å‡½æ•¸
        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                // åœ¨æ‹–æ›³çµæŸæ™‚ï¼Œè®“ç¯€é»ä½ç½®é€æ¼¸æ¢å¾©åˆ°æ¨¡æ“¬åŠ›å ´ä¸­ï¼Œè€Œä¸æ˜¯å›ºå®šä¸å‹•
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        // ç²å–ç›¸é€£ç¯€é» ID åˆ—è¡¨
        function getConnectedNodes(d, links) {
            const connected = new Set();
            // D3 æ¨¡æ“¬æœƒè‡ªå‹•å°‡ source å’Œ target æ›¿æ›ç‚ºç¯€é»ç‰©ä»¶
            links.forEach(link => {
                if (link.source.id === d.id) {
                    connected.add(link.target.id);
                } else if (link.target.id === d.id) {
                    connected.add(link.source.id);
                }
            });
            return Array.from(connected);
        }

        // é é¢è¼‰å…¥æ™‚å•Ÿå‹•åœ–è­œ
        document.addEventListener('DOMContentLoaded', loadKnowledgeGraph);

        // ç›£è½è¦–çª—å¤§å°æ”¹è®Šï¼Œä»¥ç¢ºä¿åœ–è­œå®¹å™¨éŸ¿æ‡‰å¼
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(loadKnowledgeGraph, 250); // å»¶é²é‡ç¹ªä»¥å„ªåŒ–æ€§èƒ½
        });
    </script>

    <h1 class="text-center mb-4 text-primary">ğŸ§  å¼±é»åˆ†æ</h1>

    <!-- è¿”å›æ¸¬é©—æŒ‰éˆ• -->
    <div class="view-control text-center mb-4">
        <a href="/quiz" class="btn btn-outline-primary">â† è¿”å›æ¸¬é©—é é¢</a>
    </div>

    <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
    <div id="history-loading-spinner" class="text-center my-5">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">è¼‰å…¥ä¸­...</span></div>
        <p class="mt-2 text-muted">æ­£åœ¨è¼‰å…¥é¡Œåº«åˆ†ææ•¸æ“š...</p>
    </div>

    <!-- åˆ†æå…§å®¹ -->
    <div id="history-content" class="d-none">
        <!-- æ¨™ç±¤åŒ–å¼±é»åˆ†æ (æ–°å¢) -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-danger text-white">
                <h4 class="mb-0">æ˜“éŒ¯é¡å‹</h4>
            </div>
            <div class="card-body" id="frequent-mistake-tags">
                <!-- æ˜“éŒ¯æ¨™ç±¤çµ±è¨ˆå°‡åœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ˜“éŒ¯é¡Œ Top 10 (ä¿ç•™) -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">ğŸ”¥ æ˜“éŒ¯é¡Œ Top 10</h4>
            </div>
            <div class="card-body" id="easy-mistake-questions">
                <!-- æ˜“éŒ¯é¡Œæ¸…å–®å°‡åœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ä¾†æºæ›¸ç±åˆ†æ (è®Šæ›´ç‚ºæ¬¡è¦) -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">ğŸ“š ä¾†æºæ›¸ç±éŒ¯èª¤åˆ†æ</h4>
            </div>
            <div class="card-body" id="frequent-mistake-types">
                <!-- æ˜“éŒ¯é¡å‹çµ±è¨ˆå°‡åœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>
</div>

<!-- --- é¡Œç›®è©³æƒ… Modal çµæ§‹ --- -->
<div class="modal fade" id="questionDetailModal" tabindex="-1" aria-labelledby="questionDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="questionDetailModalLabel">é¡Œç›®è©³æƒ…èˆ‡ç­†è¨˜</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- LLM è¼”åŠ©æŒ‰éˆ• (æ–°å¢) -->
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="llm-explain-btn">
                        âœ¨ å‘¼å« AI åŠ©æ•™è§£é‡‹æ­¤é¡Œ
                    </button>
                </div>

                <p class="lead" id="modal-question-text">è¼‰å…¥ä¸­...</p>
                <div id="modal-options" class="mb-3">
                    <!-- é¸é …å°‡åœ¨æ­¤è™•å‹•æ…‹å¡«å…… -->
                </div>

                <h6 class="mb-2 text-primary">æ¨™ç±¤</h6>
                <div id="modal-tags" class="mb-3"></div> <!-- æ¨™ç±¤é¡¯ç¤º (æ–°å¢) -->

                <div class="modal-question-info bg-light p-3 rounded mb-4">
                    <p><strong>æ­£ç¢ºç­”æ¡ˆ:</strong> <span class="answer-text" id="modal-answer">N/A</span></p>
                    <p><strong>ä¾†æºæ›¸ç±:</strong> <span id="modal-book-source">N/A</span></p>
                </div>

                <!-- LLM è§£é‡‹çµæœå€ (æ–°å¢) -->
                <div id="llm-explanation" class="p-3 mb-4 d-none">
                    <p class="text-muted" id="llm-explanation-text">AI åŠ©æ•™æ­£åœ¨æ€è€ƒ...</p>
                </div>

                <h6 class="mb-2 text-primary">ğŸ“ æˆ‘çš„ç­†è¨˜</h6>
                <textarea class="form-control" id="modal-user-notes" rows="4" placeholder="åœ¨é€™è£¡å¯«ä¸‹æ‚¨çš„ç†è§£æˆ–é‡é»ç­†è¨˜..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                <button type="button" class="btn btn-success" id="save-notes-btn" data-question-key="">å„²å­˜ç­†è¨˜</button>
                <div id="notes-status" class="ms-3 text-muted"></div>
            </div>
        </div>
    </div>
</div>
<!-- --- è¼‰å…¥å¿…è¦çš„å‡½å¼åº« --- -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    const globalKnowledgeBase = {{ knowledge_base | tojson }};
    const easyMistakeDiv = $('#easy-mistake-questions');
    const frequentTypesDiv = $('#frequent-mistake-types');
    const frequentTagsDiv = $('#frequent-mistake-tags'); // æ–°å¢
    const loadingSpinner = $('#history-loading-spinner');
    const historyContent = $('#history-content');

    const questionDetailModalElement = document.getElementById('questionDetailModal');
    let questionDetailModal;

    // *** [1] LLM API ç›¸é—œåƒæ•¸ï¼šä¿®æ”¹ç‚º Mistral API è·¯ç”± ***
    const mistralApiUrl = '/api/mistral_explain';

    /**
     * é¡¯ç¤ºè‡ªå®šç¾©ç‹€æ…‹è¨Šæ¯
     */
    function showStatus(message, type) {
        const statusDiv = $('#notes-status');
        statusDiv.removeClass().addClass(`ms-3 text-${type}`).text(message);
        setTimeout(() => statusDiv.text(''), 3000);
    }

    /**
     * æ¸²æŸ“æ¨™ç±¤åŒ–å¼±é»åˆ†æ (æ–°å¢)
     */
    function renderTagAnalysis() {
        const tagCounts = {};

        globalKnowledgeBase.forEach(question => {
            const errors = question.error_count || 0;
            if (errors > 0 && question.æ¨™ç±¤ && Array.isArray(question.æ¨™ç±¤)) {
                question.æ¨™ç±¤.forEach(tag => {
                    const cleanedTag = tag.trim();
                    if (cleanedTag) {
                        tagCounts[cleanedTag] = (tagCounts[cleanedTag] || 0) + errors;
                    }
                });
            }
        });

        const sortedTags = Object.entries(tagCounts)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5); // åªå–å‰äº”åå¼±é»æ¨™ç±¤

        if (sortedTags.length === 0) {
            frequentTagsDiv.html('<p class="text-success">ğŸ‰ ç›®å‰åœ¨æ‰€æœ‰ AI çŸ¥è­˜é»ä¸Šçš„éŒ¯èª¤æ¬¡æ•¸å‡ç‚º 0ã€‚</p>');
        } else {
            frequentTagsDiv.html(sortedTags.map(([tag, count], index) => `
                <div class="history-stat-item">
                    <p class="mb-1 fw-bold">ç¬¬ ${index + 1} åå¼±é»ï¼š<span class="tag-badge bg-danger">${tag}</span></p>
                    <p class="mb-0 text-danger">ç´¯ç©éŒ¯èª¤æ¬¡æ•¸ï¼š${count}</p>
                    <p class="mb-0 text-muted">æç¤ºï¼šæ‡‰å„ªå…ˆè¤‡ç¿’æ­¤æ¨™ç±¤ç›¸é—œçš„çŸ¥è­˜é»ã€‚</p>
                </div>
            `).join(''));
        }
    }


    /**
     * æ¸²æŸ“æ˜“éŒ¯é¡Œæ¸…å–®å’Œåˆ†é¡çµ±è¨ˆ
     */
    function renderAnalysis() {
        if (!globalKnowledgeBase || globalKnowledgeBase.length === 0) {
            loadingSpinner.hide();
            historyContent.html('<p class="text-center text-danger">âš ï¸ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°çŸ¥è­˜åº«æ•¸æ“šé€²è¡Œåˆ†æã€‚</p>').removeClass('d-none');
            return;
        }

        // ç¢ºä¿æ¯æ¢æ•¸æ“šéƒ½æœ‰ä¸€å€‹ 'index' æ¬„ä½ï¼Œä»¥ä¾¿å‰ç«¯å¯ä»¥æ­£ç¢ºå¼•ç”¨ï¼ˆå¦‚æœå¾Œç«¯æ²’æœ‰æä¾›ï¼‰
        globalKnowledgeBase.forEach((q, index) => q.index = index);

        // 1. è™•ç†æ˜“éŒ¯é¡Œ (éŒ¯èª¤æ¬¡æ•¸ >= 1 çš„é¡Œç›®)
        const mistakeQuestions = globalKnowledgeBase
            .filter(q => (q.error_count || 0) >= 1)
            .sort((a, b) => (b.error_count || 0) - (a.error_count || 0))
            .slice(0, 10);

        if (mistakeQuestions.length === 0) {
            easyMistakeDiv.html('<p class="text-success">å¤ªæ£’äº†ï¼ç›®å‰å…¨åŸŸéŒ¯èª¤æ¬¡æ•¸å‡ç‚º 0ã€‚</p>');
        } else {
            easyMistakeDiv.html(mistakeQuestions.map(m => {
                const qText = m.é¡Œç›® || m.question_text || 'é¡Œç›®å…§å®¹ç¼ºå¤±';
                return `
                <div class="history-stat-item clickable-question" data-question-key="${qText}">
                    <p class="mb-1 fw-bold">${qText}</p>
                    <p class="mb-0 text-danger">å…¨åŸŸéŒ¯èª¤æ¬¡æ•¸ï¼š${m.error_count}</p>
                    <p class="mb-0 text-muted">ä¾†æºï¼š${m.ä¾†æºæ›¸ç± || m.book_source || 'N/A'}</p>
                </div>
            `;
            }).join(''));
        }

        // 2. è™•ç†ä¾†æºæ›¸ç±çµ±è¨ˆ (ä¿æŒä¸è®Š)
        const typeCounts = {};

        globalKnowledgeBase.forEach(question => {
            const typeKey = question['ä¾†æºæ›¸ç±'] || question['book_source'] || 'æœªåˆ†é¡';
            const errors = question.error_count || 0;
            typeCounts[typeKey] = (typeCounts[typeKey] || 0) + errors;
        });

        const sortedTypes = Object.entries(typeCounts)
            .filter(([, count]) => count > 0)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5);

        if (sortedTypes.length === 0) {
            frequentTypesDiv.html('<p class="text-success">ç›®å‰æ‰€æœ‰åˆ†é¡éŒ¯èª¤ç¸½æ¬¡æ•¸å‡ç‚º 0ã€‚</p>');
        } else {
            frequentTypesDiv.html(sortedTypes.map(([type, count], index) => `
                <div class="history-stat-item">
                    <p class="mb-1 fw-bold">ç¬¬ ${index + 1} åï¼š${type}</p>
                    <p class="mb-0 text-danger">ç¸½éŒ¯èª¤æ¬¡æ•¸ï¼š${count}</p>
                </div>
            `).join(''));
        }

        // 3. æ¸²æŸ“æ¨™ç±¤åˆ†æ
        renderTagAnalysis();


        loadingSpinner.hide();
        historyContent.removeClass('d-none');
    }

    // --- é»æ“Šäº‹ä»¶è™•ç† (ç¶­æŒä¸è®Š) ---

    $(document).on('click', '.clickable-question', function() {
        const questionKey = $(this).data('question-key');

        if (!questionKey || questionKey === 'é¡Œç›®å…§å®¹ç¼ºå¤±') {
            console.error("DANGER: ç„¡æ³•è§£æé¡Œç›® Key (å…§å®¹)ã€‚");
            showStatus('éŒ¯èª¤ï¼šç„¡æ³•è§£æé¡Œç›®å…§å®¹ã€‚', 'danger');
            return;
        }

        const encodedKey = encodeURIComponent(questionKey);
        const apiUrlDetail = `/api/question/${encodedKey}`;

        // 1. é‡è¨­ Modal å…§å®¹ç‚ºè¼‰å…¥ç‹€æ…‹
        $('#modal-question-text').text('è¼‰å…¥ä¸­...');
        $('#modal-options').empty();
        $('#modal-answer').text('N/A');
        $('#modal-book-source').text('N/A');
        $('#modal-tags').empty(); // æ¸…ç©ºæ¨™ç±¤
        $('#modal-user-notes').val('');
        $('#notes-status').text('');
        $('#llm-explanation').addClass('d-none'); // éš±è— LLM å€
        $('#llm-explanation-text').text('AI åŠ©æ•™æ­£åœ¨æ€è€ƒ...'); // é‡è¨­ LLM æ–‡æœ¬
        $('#save-notes-btn').prop('disabled', true).text('å„²å­˜ç­†è¨˜').removeAttr('data-question-key');
        $('#llm-explain-btn').prop('disabled', true).text('âœ¨ å‘¼å« AI åŠ©æ•™è§£é‡‹æ­¤é¡Œ');

        // 2. ç«‹å³é¡¯ç¤º Modal
        if (questionDetailModal) {
            questionDetailModal.show();
        } else {
             console.error("Bootstrap Modal ç‰©ä»¶æœªåˆå§‹åŒ–ï¼");
             return;
        }

        // 3. å‘¼å« API ç²å–é¡Œç›®è©³æƒ…
        console.log(`[DEBUG] æ­£åœ¨ç™¼é€ GET è«‹æ±‚åˆ°: ${apiUrlDetail}`);

        $.ajax({
            url: apiUrlDetail,
            type: 'GET',
            success: function(data) {
                console.log(`[DEBUG] API è«‹æ±‚æˆåŠŸï¼Œæ”¶åˆ°æ•¸æ“š:`, data);

                // å¡«å…… Modal å…§å®¹
                $('#modal-question-text').text(data.question_text);
                $('#modal-answer').text(data.answer);
                $('#modal-book-source').text(data.book_source);
                $('#modal-user-notes').val(data.user_notes);

                // æ¸²æŸ“é¸é …
                const labels = ['A', 'B', 'C', 'D', 'E'];
                let optionsHtml = '';
                (data.options || []).forEach((opt, index) => {
                    optionsHtml += `<p class="mb-1">(${labels[index]}) ${opt}</p>`;
                });
                $('#modal-options').html(optionsHtml);

                // æ¸²æŸ“æ¨™ç±¤
                let tagsHtml = '';
                (data.tags || []).forEach(tag => {
                    tagsHtml += `<span class="tag-badge bg-secondary">${tag}</span>`;
                });
                $('#modal-tags').html(tagsHtml || '<p class="text-muted">ç„¡æ¨™ç±¤è³‡è¨Š</p>');


                // å•Ÿç”¨å„²å­˜æŒ‰éˆ•å’Œ LLM æŒ‰éˆ•
                $('#save-notes-btn').prop('disabled', false).attr('data-question-key', data.question_key);
                $('#llm-explain-btn').prop('disabled', false).attr('data-question-text', data.question_text);
                $('#llm-explain-btn').attr('data-user-notes', data.user_notes || '');

            },
            error: function(jqXHR) {
                const errorMsg = jqXHR.responseJSON ? (jqXHR.responseJSON.error || JSON.stringify(jqXHR.responseJSON)) : jqXHR.responseText;
                console.error(`[ERROR] ç²å–é¡Œç›®è©³æƒ…å¤±æ•— (${jqXHR.status}):`, errorMsg);

                $('#modal-question-text').html(`<strong>è¼‰å…¥å¤±æ•—ï¼</strong> éŒ¯èª¤ç¢¼: ${jqXHR.status}ã€‚è«‹æª¢æŸ¥å¾Œç«¯æ—¥èªŒã€‚`);
                showStatus(`éŒ¯èª¤: è¼‰å…¥è©³æƒ…å¤±æ•—ã€‚${jqXHR.status}`, 'danger');
                $('#llm-explain-btn').prop('disabled', true); // è¼‰å…¥å¤±æ•—ç¦ç”¨ LLM
            }
        });
    });

    // --- å„²å­˜ç­†è¨˜è™•ç† (ä¿æŒä¸è®Š) ---
    $('#save-notes-btn').on('click', function() {
        const qKey = $(this).data('question-key');
        const notes = $('#modal-user-notes').val();

        if (!qKey) {
             showStatus('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é¡Œç›® Keyã€‚', 'danger');
             return;
        }

        $('#save-notes-btn').prop('disabled', true).text('å„²å­˜ä¸­...');

        $.ajax({
            url: '/api/save_notes',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ question_key: qKey, user_notes: notes }),
            success: function(response) {
                showStatus(response.message || 'å„²å­˜æˆåŠŸï¼', 'success');
                $('#save-notes-btn').prop('disabled', false).text('å„²å­˜ç­†è¨˜');
            },
            error: function(jqXHR) {
                const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.error : 'æœªçŸ¥éŒ¯èª¤';
                showStatus(`å„²å­˜å¤±æ•—: ${errorMsg}`, 'danger');
                console.error("å„²å­˜ç­†è¨˜å¤±æ•—:", errorMsg);
                $('#save-notes-btn').prop('disabled', false).text('å„²å­˜ç­†è¨˜');
            }
        });
    });

    // *** [2] LLM è¼”åŠ©æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼šæ”¹ç‚ºå‘¼å« /api/mistral_explain ***
    $('#llm-explain-btn').on('click', async function() {
        const btn = $(this);
        const questionText = btn.attr('data-question-text');
        const userNotes = $('#modal-user-notes').val();
        const explanationDiv = $('#llm-explanation');
        const explanationText = $('#llm-explanation-text');

        if (!questionText) {
            explanationText.text('éŒ¯èª¤ï¼šç„¡æ³•ç²å–é¡Œç›®å…§å®¹ã€‚');
            explanationDiv.removeClass('d-none').addClass('bg-danger text-white');
            return;
        }

        // 1. è¨­ç½® UI ç‚ºè¼‰å…¥ç‹€æ…‹
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> AI æ­£åœ¨åˆ†æ...');
        explanationText.text('AI åŠ©æ•™æ­£åœ¨åˆ†æé¡Œç›®èˆ‡æ•¸æ“šï¼Œè«‹ç¨å€™...');
        explanationDiv.removeClass('d-none bg-danger text-white').addClass('bg-info text-dark');
        explanationDiv.css('border-left-color', '#007bff'); // é‡è¨­é‚Šæ¡†é¡è‰²

        const payload = {
            question_text: questionText,
            user_notes: userNotes // å‚³éç­†è¨˜çµ¦å¾Œç«¯
        };

        try {
            console.log(`[DEBUG] å‘¼å« Mistral API: ${mistralApiUrl}`);

            // ä½¿ç”¨ jQuery.ajax å‘¼å«å¾Œç«¯è·¯ç”±
            const response = await $.ajax({
                url: mistralApiUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload)
            });

            // æˆåŠŸçš„å›æ‡‰
            const text = response.explanation;

            if (text) {
                // Mistral çš„å›æ‡‰æ˜¯ Markdownï¼Œé€™è£¡å°‡å…¶é¡¯ç¤ºç‚ºç´”æ–‡æœ¬ï¼ˆæ‚¨å¯ä»¥åŠ å…¥ Markdown è½‰ HTML å‡½å¼ä¾†æ”¹é€²ï¼‰
                explanationText.html(text.replace(/\n/g, '<br>'));
                explanationDiv.removeClass('bg-info text-dark').addClass('bg-light text-dark').css('border-left-color', '#198754');
            } else {
                explanationText.text('AI åŠ©æ•™ç„¡æ³•ç”Ÿæˆè§£é‡‹ï¼Œå¾Œç«¯å›å‚³å…§å®¹ç‚ºç©ºã€‚');
                explanationDiv.removeClass('bg-info text-dark').addClass('bg-danger text-white').css('border-left-color', '#dc3545');
            }

        } catch (jqXHR) {
            const errorMsg = jqXHR.responseJSON ? (jqXHR.responseJSON.error || JSON.stringify(jqXHR.responseJSON)) : 'æœªçŸ¥éŒ¯èª¤';
            console.error('Mistral API å‘¼å«å¤±æ•—:', errorMsg);
            explanationText.text('AI åŠ©æ•™æœå‹™é€£ç·šå¤±æ•—ï¼š' + errorMsg);
            explanationDiv.removeClass('bg-info text-dark').addClass('bg-danger text-white').css('border-left-color', '#dc3545');
        } finally {
            btn.prop('disabled', false).html('âœ¨ å‘¼å« AI åŠ©æ•™è§£é‡‹æ­¤é¡Œ');
        }
    });


    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œåˆ†æ
    $(document).ready(function() {
        // ç¢ºä¿ Modal åœ¨ DOM è¼‰å…¥å¾Œåˆå§‹åŒ–
        if (questionDetailModalElement) {
            questionDetailModal = new bootstrap.Modal(questionDetailModalElement);
        } else {
            console.error("Modal element #questionDetailModal not found!");
        }
        renderAnalysis();
    });

</script>
{% endblock %}
