{% extends "layout.html" %}

{% block content %}

<style>
    /* 引用 Bootstrap 和 Inter 字體（假設您已在 layout.html 或其他地方引入）*/
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8f9fa;
    }

    .card {
        border-radius: 12px;
        transition: border 0.3s, background-color 0.3s;
    }

    .card-header {
        border-bottom: none;
    }

    .btn-lg {
        border-radius: 8px;
    }
    /* 避免使用 alert/confirm，改用 custom UI */
    #custom-alert {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        border-radius: 8px;
    }
    /* 評分結果樣式 */
    .question-card.correct {
        border: 2px solid #198754; /* 綠色邊框 */
        background-color: #e6ffed; /* 淺綠色背景 */
    }

    .question-card.incorrect {
        border: 2px solid #dc3545; /* 紅色邊框 */
        background-color: #ffebe6; /* 淺紅色背景 */
    }

    .result-footer {
        background-color: #f8f9fa;
        border-top: 1px dashed #ced4da;
        padding: 10px 15px;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
    }

    /* --- 新增：選項標記樣式 (用於顯示正確答案和錯誤選擇) --- */
    .form-check-label {
        transition: color 0.3s;
        font-weight: normal;
    }

        .form-check-label.correct-option {
            font-weight: bold;
            color: #198754 !important; /* 綠色，正確答案 */
        }

        .form-check-label.user-incorrect-choice {
            font-weight: bold;
            color: #dc3545 !important; /* 紅色，使用者選錯的答案 */
            text-decoration: line-through; /* 加上刪除線 */
        }
    /* --- 新增：選項標記樣式 END --- */


    .result-correct-badge {
        color: #198754;
        font-weight: bold;
        margin-left: 10px;
    }

    .result-incorrect-badge {
        color: #dc3545;
        font-weight: bold;
        margin-left: 10px;
    }

    /* 模式選擇樣式 */
    .mode-selection-card {
        max-width: 600px;
        width: 100%;
        margin: auto;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        min-height: 50vh;
    }

    .btn-mode {
        padding: 20px 30px;
        font-size: 1.5rem;
        font-weight: bold;
        border-radius: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
        text-align: left;
    }

        .btn-mode:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

    /* 新增：測驗介面佈局 */
    .quiz-container {
        display: flex;
        gap: 30px;
    }

    .quiz-main-content {
        flex-grow: 1;
        max-width: 800px;
    }

    /* 新增：題目導覽列樣式 */
    #question-navigator-wrap {
        width: 250px;
        flex-shrink: 0;
        position: sticky;
        top: 20px;
        align-self: flex-start;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }

    #question-navigator .nav-item {
        display: inline-block;
        margin: 5px;
    }

    .nav-link-q {
        display: block;
        width: 40px;
        height: 40px;
        line-height: 40px;
        text-align: center;
        border-radius: 8px;
        background-color: #e9ecef; /* 預設未作答 */
        color: #495057;
        font-weight: 500;
        transition: background-color 0.2s, transform 0.1s;
        text-decoration: none;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

        .nav-link-q:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-link-q.answered {
            background-color: #38c172; /* 已作答 (可以調整顏色) */
            color: white;
            box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
        }

        .nav-link-q.incorrect-result {
            background-color: #dc3545; /* 結果錯誤 */
            color: white;
        }

        .nav-link-q.correct-result {
            background-color: #198754; /* 結果正確 */
            color: white;
        }
</style>

<div id="custom-alert" class="alert alert-warning shadow-lg" role="alert">
    <strong>注意！</strong> 您還有未作答的題目。
</div>

<div class="container my-5">

    {% if mode == 'selection' %}

    <div class="mode-selection-card bg-white p-5 d-flex flex-column justify-content-center">
        <h1 class="text-center text-3xl font-weight-bold text-dark mb-4">🩺 測驗模式選擇</h1>
        <p class="text-center text-secondary mb-5">請選擇您要開始的練習模式。</p>

        {% if error_message %}
        <div class="alert alert-danger text-center">{{ error_message }}</div>
        {% endif %}

        <div class="d-grid gap-4">
            <a href="{{ url_for('quiz', mode='normal') }}" class="btn btn-mode btn-primary text-white">
                <div class="d-flex align-items-center">
                    <span class="fs-1 me-4">🎲</span>
                    <div>
                        隨機模擬測驗
                        <div class="text-sm fw-normal mt-1 opacity-75 text-white">從所有題庫中隨機選取題目，進行全面測試。</div>
                    </div>
                </div>
            </a>

            <a href="{{ url_for('quiz', mode='weakness') }}" class="btn btn-mode btn-danger text-white">
                <div class="d-flex align-items-center">
                    <span class="fs-1 me-4">💪</span>
                    <div>
                        弱點加強模式
                        <div class="text-sm fw-normal mt-1 opacity-75 text-white">針對您 **錯誤次數最多** 的題目進行重點練習。</div>
                    </div>
                </div>
            </a>

            <a href="{{ url_for('quiz', mode='practice') }}" class="btn btn-mode btn-warning">
                <div class="d-flex align-items-center">
                    <span class="fs-1 me-4">🔁</span>
                    <div>
                        錯題重練模式
                        <div class="text-sm fw-normal mt-1 opacity-75 text-dark">僅包含您過去**答錯或標記收藏**的題目，鞏固學習。</div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    {% else %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-center mb-0">{{ title }}</h1>
        <a href="{{ url_for('quiz', mode='selection') }}" class="btn btn-secondary btn-sm shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8" />
            </svg>
            返回模式選擇
        </a>
    </div>

    <p class="text-center text-muted">選擇題 <strong>{{ quiz_data | length }}</strong> 題，請選擇一個最正確的答案。</p>

    <div class="quiz-container">
        <div id="question-navigator-wrap" class="card shadow-sm p-3">
            <h5 class="card-title text-center mb-3">題目概覽</h5>
            <div id="question-navigator" class="text-center">
            </div>
        </div>

        <div class="quiz-main-content">
            <form id="quiz-form">
                {% for question in quiz_data %}

                {% set q_index = loop.index %}

                <div class="card shadow-sm mb-4 question-card" data-question-index="{{ q_index }}" id="q-{{ q_index }}">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">第 {{ q_index }} 題</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text fw-bold">{{ question.題目 }}</p>

                        {% for option in question.選項 %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio"
                                   name="question-{{ q_index }}"
                                   id="q{{ q_index }}-o{{ loop.index }}"
                                   value="{{ option }}"
                                   data-q-index="{{ q_index }}">
                            <label class="form-check-label" for="q{{ q_index }}-o{{ loop.index }}">
                                {{ option }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="card-footer result-footer d-none"></div>
                </div>
                {% endfor %}

                <div id="submit-area" class="text-center mt-5 mb-5">
                    <button type="submit" class="btn btn-success btn-lg px-5">送出測驗</button>
                </div>
            </form>
            <div id="result-summary" class="card shadow-lg mb-5 d-none">
                <div class="card-body text-center">
                    <h2 class="card-title text-primary">測驗結果</h2>
                    <p class="h3 mb-0">總分：<strong id="final-score" class="text-success"></strong> / <span id="max-score"></span></p>
                    <p class="lead mt-2">答對：<strong id="correct-count-summary" class="text-success"></strong> 題 / 答錯：<strong id="incorrect-count-summary" class="text-danger"></strong> 題</p>
                    <a id="view-report-btn" href="#" class="btn btn-primary mt-3 px-4">查看詳細報告</a>
                </div>
            </div>
        </div>
    </div>{% endif %}

</div>

<script>
    // 只有在測驗模式下才執行 JavaScript 邏輯
    if (document.getElementById('quiz-form')) {
        // 從 Flask/Jinja 接收數據
        const quizData = {{ quiz_data | tojson | safe }};
        const form = document.getElementById('quiz-form');
        const submitArea = document.getElementById('submit-area');
        const resultSummary = document.getElementById('result-summary');
        const customAlert = document.getElementById('custom-alert');
        const totalQuestions = quizData.length;
        const navigatorDiv = document.getElementById('question-navigator');

        // 顯示自訂警告訊息
        function showAlert(message) {
            customAlert.innerHTML = `<strong>注意！</strong> ${message}`;
            customAlert.style.display = 'block';
            setTimeout(() => {
                customAlert.style.display = 'none';
            }, 5000); // 5秒後自動關閉
        }

        // --- 導覽列相關函式 (保持不變) ---
        function generateNavigator() {
            for (let i = 1; i <= totalQuestions; i++) {
                const navItem = document.createElement('div');
                navItem.classList.add('nav-item');
                const navLink = document.createElement('a');
                navLink.classList.add('nav-link-q');
                navLink.textContent = i;
                navLink.id = `nav-q-${i}`;
                navLink.setAttribute('data-q-index', i);
                navLink.addEventListener('click', function() {
                    const targetId = `q-${i}`;
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        this.style.transform = 'scale(1.1)';
                        setTimeout(() => this.style.transform = 'scale(1)', 200);
                    }
                });
                navItem.appendChild(navLink);
                navigatorDiv.appendChild(navItem);
            }
        }

        function updateNavigator(questionIndex, isAnswered, isResultMode = false, isCorrect = false) {
            const navLink = document.getElementById(`nav-q-${questionIndex}`);
            if (navLink) {
                // 清除所有結果模式類別
                navLink.classList.remove('answered', 'correct-result', 'incorrect-result');

                if (isResultMode) {
                    navLink.classList.add(isCorrect ? 'correct-result' : 'incorrect-result');
                } else if (isAnswered) {
                    navLink.classList.add('answered');
                }
            }
        }

        function setupAnswerListener() {
            const radioInputs = form.querySelectorAll('input[type="radio"]');
            radioInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const qIndex = this.getAttribute('data-q-index');
                    updateNavigator(qIndex, true);
                });
                if (input.checked) {
                    const qIndex = input.getAttribute('data-q-index');
                    updateNavigator(qIndex, true);
                }
            });
        }
        // --- 導覽列相關函式 END ---


        // 顯示評分結果的函式 (核心修正區，與您的要求一致)
        function displayResults(result) {
            // 1. 更新結果總結區塊
            document.getElementById('final-score').textContent = result.total_score;
            document.getElementById('max-score').textContent = result.total_questions * result.score_per_question;
            document.getElementById('correct-count-summary').textContent = result.correct_count;
            document.getElementById('incorrect-count-summary').textContent = result.total_questions - result.correct_count;

            // 隱藏提交區，顯示結果總結區
            if (submitArea) submitArea.classList.add('d-none');
            if (resultSummary) resultSummary.classList.remove('d-none');

            // 2. 標記每一題的結果和正確答案
            if (result.detailed_results) {
                result.detailed_results.forEach(item => {
                    // qIndex 是 1-based index (從 1 開始)
                    const qIndex = item.question_index;
                    const isCorrect = item.is_correct;
                    const correctOption = item.correct_answer;

                    const questionCard = document.getElementById(`q-${qIndex}`);
                    if (!questionCard) return;

                    const resultFooter = questionCard.querySelector('.result-footer');

                    // 標記題卡顏色
                    questionCard.classList.add(isCorrect ? 'correct' : 'incorrect');

                    // 標記選項顏色並禁用選項
                    const radioInputs = questionCard.querySelectorAll('input[type="radio"]');
                    radioInputs.forEach(radio => {
                        radio.disabled = true; // 禁用所有選項
                        const label = radio.nextElementSibling;

                        // 移除舊的標記類別
                        label.classList.remove('correct-option', 'user-incorrect-choice');

                        // 1. 標記正確答案 (Always Green)
                        if (radio.value === correctOption) {
                            label.classList.add('correct-option');
                        }

                        // 2. 標記使用者選擇 (Red if incorrect)
                        if (radio.checked && !isCorrect) {
                            label.classList.add('user-incorrect-choice');
                        }
                    });

                    // 顯示結果詳情區 (在 footer 顯示總結資訊)
                    const summaryHtml = `
                        <div class="d-flex flex-wrap justify-content-between align-items-center">
                            <div class="text-sm text-dark">
                                <strong>標準答案：</strong> <span class="font-weight-bold text-success">${correctOption}</span>
                            </div>
                        </div>
                    `;
                    // 確保 footer 顯示
                    resultFooter.innerHTML = summaryHtml;
                    resultFooter.classList.remove('d-none');

                    // 更新導覽列狀態
                    updateNavigator(qIndex, true, true, isCorrect);
                });
            }
        }


        // 處理表單提交
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // 1. 收集使用者答案 (邏輯不變)
            const userAnswers = {};
            const answeredQuestions = new Set();
            quizData.forEach((_, index) => {
                const questionIndex = index + 1;
                const radios = document.getElementsByName(`question-${questionIndex}`);
                for (const radio of radios) {
                    if (radio.checked) {
                        userAnswers[`question-${questionIndex}`] = radio.value;
                        answeredQuestions.add(questionIndex);
                        break;
                    }
                }
            });

            const answeredCount = answeredQuestions.size;
            if (answeredCount < totalQuestions) {
                showAlert(`您還有 ${totalQuestions - answeredCount} 題未作答。`);
                return;
            }

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '評分中...';

            // 2. 發送答案並處理響應
            try {
                const response = await fetch('/submit_quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // 將 quiz_data 一起傳回後端，以便後端查閱答案
                    body: JSON.stringify({ answers: userAnswers, quiz_data: quizData })
                });

                let responseBody;
                try {
                    responseBody = await response.json();
                } catch (e) {
                    console.error("JSON Parsing Error:", e);
                    throw new Error(`伺服器返回非 JSON 格式響應。狀態碼: ${response.status}。`);
                }

                if (!response.ok || !responseBody.success) {
                    const errorMessage = responseBody.message || responseBody.error || '未知伺服器錯誤';
                    throw new Error(`評分處理失敗 (${response.status}): ${errorMessage}`);
                }

                // 3. 成功處理：顯示結果回饋
                // 由於後端現在返回了 detailed_results，可以立即顯示
                displayResults(responseBody);

                // 設定查看報告按鈕點擊事件
                // 這裡假設報告頁面的 URL 是 /report_page
                document.getElementById('view-report-btn').href = '/report_page';

            } catch (error) {
                // 4. 錯誤處理
                console.error('評分失敗:', error);
                showAlert('評分時發生錯誤，請稍後再試。錯誤細節：' + error.message);
                // 恢復按鈕
                submitButton.disabled = false;
                submitButton.textContent = '送出測驗';
            }
        });

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', () => {
            if (totalQuestions > 0) {
                generateNavigator();
                setupAnswerListener();
            }
        });
    }
</script>

    {% endblock %}