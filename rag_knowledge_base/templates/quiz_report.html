<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬é©—æˆç¸¾çµ±è¨ˆèˆ‡å ±è¡¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Chart.js for æ•¸æ“šå¯è¦–åŒ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }

        .container-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-4 border-indigo-500 pb-2">ğŸ“Š æ¸¬é©—æˆç¸¾åˆ†æå ±å‘Š</h1>

        <!-- ç¸½æˆç¸¾æ¦‚è¦½ -->
        <div id="summary-section" class="container-card bg-white p-6 rounded-xl mb-8">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">ç¸½æˆç¸¾æ¦‚è¦½</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div class="bg-indigo-100 p-4 rounded-lg">
                    <p class="text-sm text-indigo-600 font-semibold">ç¸½é¡Œæ•¸</p>
                    <p id="total-questions" class="text-4xl font-extrabold text-indigo-900 mt-1">0</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg">
                    <p class="text-sm text-green-600 font-semibold">ç­”å°é¡Œæ•¸ / ç¸½åˆ†</p>
                    <p id="correct-count" class="text-4xl font-extrabold text-green-900 mt-1">0 / 0</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <p class="text-sm text-yellow-600 font-semibold">ç¸½æ­£ç¢ºç‡</p>
                    <p id="overall-accuracy" class="text-4xl font-extrabold text-yellow-900 mt-1">0%</p>
                </div>
            </div>
        </div>

        <!-- åœ–è¡¨å€å¡Š -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

            <!-- åœ“é¤…åœ–ï¼šé¡Œç›®åˆ†ä½ˆ -->
            <div class="lg:col-span-1 container-card bg-white p-6 rounded-xl flex flex-col items-center">
                <h2 class="text-xl font-bold text-gray-700 mb-4">ç« ç¯€ï¼ˆä¾†æºæ›¸ç±ï¼‰é¡Œç›®åˆ†ä½ˆ</h2>
                <div class="w-full h-80">
                    <canvas id="topicDistributionChart"></canvas>
                </div>
            </div>

            <!-- é•·æ¢åœ–ï¼šç« ç¯€æ­£ç¢ºç‡ -->
            <div class="lg:col-span-2 container-card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-bold text-gray-700 mb-4">å¼±é»ç« ç¯€åˆ†æ (æ­£ç¢ºç‡é•·æ¢åœ–)</h2>
                <div class="w-full h-96">
                    <canvas id="accuracyBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- è©³ç´°ç« ç¯€æˆç¸¾è¡¨æ ¼ -->
        <div class="container-card bg-white p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">ğŸ“š è©³ç´°ç« ç¯€æˆç¸¾</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ä¾†æºæ›¸ç± (ç« ç¯€)
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ç¸½é¡Œæ•¸
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ç­”å°é¡Œæ•¸
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                æ­£ç¢ºç‡
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                å¼±é»æŒ‡æ¨™
                            </th>
                        </tr>
                    </thead>
                    <tbody id="accuracy-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- æ•¸æ“šå°‡ç”± JS å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // ----------------------------------------------------------------------
        // æ¸¬é©—çµæœæ•¸æ“šç”±å¾Œç«¯ Flask (app.py) å‚³å…¥
        // ----------------------------------------------------------------------

        // å¾å¾Œç«¯æ¥æ”¶çš„æ¸¬é©—çµæœæ•¸æ“šï¼ˆåŒ…å« book_source å’Œ is_correctï¼‰
        const quizResults = {{ quiz_results | tojson | safe }};

        // æ¯é¡Œåˆ†æ•¸ç‚º 2 åˆ†
        const SCORE_PER_QUESTION = 2;

        // é¡è‰²é…ç½® (ç”¨æ–¼åœ–è¡¨)
        const ACCURACY_COLORS = [
            '#4f46e5', // Indigo
            '#10b981', // Green
            '#f59e0b', // Amber
            '#ef4444', // Red
            '#06b6d4', // Cyan
            '#9333ea', // Violet
            '#be185d', // Pink
            '#374151', // Gray
        ];

        /**
         * è™•ç†æ¸¬é©—çµæœï¼Œè¨ˆç®—ç¸½æˆç¸¾å’Œå„ç« ç¯€çš„æº–ç¢ºç‡ã€‚
         * @param {Array} results - æ¸¬é©—çµæœé™£åˆ—ã€‚
         * @returns {Object} åŒ…å«ç¸½çµå’Œç« ç¯€æ˜ç´°çš„ç‰©ä»¶ã€‚
         */
        function analyzeResults(results) {
            let totalQuestions = results.length;
            let correctCount = 0;
            const bookAccuracy = {};

            results.forEach(item => {
                // è™•ç†ä¾†æºæ›¸ç±ï¼Œå¦‚æœç‚ºç©ºå‰‡è¨­ç‚º 'æœªçŸ¥ç« ç¯€'
                const book = item.book_source || 'æœªçŸ¥ç« ç¯€';
                const isCorrect = item.is_correct;

                // 1. ç¸½è¨ˆæ­£ç¢ºé¡Œæ•¸
                if (isCorrect) {
                    correctCount++;
                }

                // 2. åˆå§‹åŒ–æˆ–æ›´æ–°ç« ç¯€æ•¸æ“š
                if (!bookAccuracy[book]) {
                    bookAccuracy[book] = { total: 0, correct: 0, accuracy: 0, color: '' };
                }

                bookAccuracy[book].total++;
                if (isCorrect) {
                    bookAccuracy[book].correct++;
                }
            });

            // 3. è¨ˆç®—å„ç« ç¯€æº–ç¢ºç‡ä¸¦åˆ†é…é¡è‰²
            const sortedBooks = Object.keys(bookAccuracy).sort();
            sortedBooks.forEach((book, index) => {
                const data = bookAccuracy[book];
                data.accuracy = data.total > 0 ? (data.correct / data.total) * 100 : 0;
                // åˆ†é…é¡è‰²
                data.color = ACCURACY_COLORS[index % ACCURACY_COLORS.length];
            });

            return {
                totalQuestions,
                correctCount,
                bookAccuracy,
            };
        }

        /**
         * æ¸²æŸ“æˆç¸¾æ¦‚è¦½å€å¡Šã€‚
         * @param {Object} summary - æˆç¸¾ç¸½çµæ•¸æ“šã€‚
         */
        function renderSummary(summary) {
            const { totalQuestions, correctCount } = summary;
            const totalScore = correctCount * SCORE_PER_QUESTION;
            const overallAccuracy = totalQuestions > 0 ? (correctCount / totalQuestions * 100).toFixed(1) : 0;

            document.getElementById('total-questions').textContent = totalQuestions;
            document.getElementById('correct-count').textContent = `${correctCount} / ${totalScore}`;
            document.getElementById('overall-accuracy').textContent = `${overallAccuracy}%`;
        }

        /**
         * æ¸²æŸ“è©³ç´°ç« ç¯€æˆç¸¾è¡¨æ ¼ã€‚
         * @param {Object} bookAccuracy - å„ç« ç¯€çš„æˆç¸¾æ•¸æ“šã€‚
         */
        function renderTable(bookAccuracy) {
            const tbody = document.getElementById('accuracy-table-body');
            tbody.innerHTML = '';

            // å°‡ç« ç¯€æ•¸æ“šè½‰æ›ç‚ºé™£åˆ—ä¸¦æŒ‰æº–ç¢ºç‡å‡åºæ’åˆ— (å¼±é»åœ¨å‰)
            const sortedEntries = Object.entries(bookAccuracy)
                .sort(([, a], [, b]) => a.accuracy - b.accuracy);

            sortedEntries.forEach(([book, data]) => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-100';

                // å¼±é»æŒ‡æ¨™ï¼šä½æ–¼ 60% æ¨™ç´…
                // åªæœ‰é¡Œç›®æ•¸å¤§æ–¼ 1 ä¸”æ­£ç¢ºç‡ä½æ–¼ 60% æ‰æ¨™è¨˜ç‚ºã€Œéœ€åŠ å¼·ã€
                const isWeakSpot = data.accuracy < 60 && data.total > 1;

                const indicatorClass = isWeakSpot ? 'bg-red-500 text-white font-semibold rounded-full p-1 text-xs text-center' : 'bg-green-500 text-white rounded-full p-1 text-xs text-center';
                const indicatorText = isWeakSpot ? 'âš ï¸ éœ€åŠ å¼·' : 'âœ… æŒæ¡';

                // ä¾†æºæ›¸ç± (ç« ç¯€)
                row.insertCell().textContent = book;

                // ç¸½é¡Œæ•¸
                row.insertCell().textContent = data.total;

                // ç­”å°é¡Œæ•¸
                row.insertCell().textContent = data.correct;

                // æ­£ç¢ºç‡
                row.insertCell().textContent = `${data.accuracy.toFixed(1)}%`;

                // å¼±é»æŒ‡æ¨™
                const indicatorCell = row.insertCell();
                indicatorCell.innerHTML = `<span class="${indicatorClass}" style="min-width: 80px; display: inline-block;">${indicatorText}</span>`;
            });
        }

        // Chart å¯¦ä¾‹å„²å­˜ï¼Œç”¨æ–¼é¿å…é‡è¤‡æ¸²æŸ“
        let distributionChartInstance = null;
        let accuracyChartInstance = null;

        /**
         * æ¸²æŸ“é¡Œç›®åˆ†ä½ˆåœ“é¤…åœ– (Pie Chart)ã€‚
         * @param {Object} bookAccuracy - å„ç« ç¯€çš„æˆç¸¾æ•¸æ“šã€‚
         */
        function renderDistributionChart(bookAccuracy) {
            if (distributionChartInstance) {
                distributionChartInstance.destroy();
            }

            const labels = Object.keys(bookAccuracy);
            const data = labels.map(book => bookAccuracy[book].total);
            const colors = labels.map(book => bookAccuracy[book].color);

            distributionChartInstance = new Chart(document.getElementById('topicDistributionChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é¡Œç›®æ•¸é‡',
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }

        /**
         * æ¸²æŸ“ç« ç¯€æ­£ç¢ºç‡é•·æ¢åœ– (Bar Chart)ã€‚
         * @param {Object} bookAccuracy - å„ç« ç¯€çš„æˆç¸¾æ•¸æ“šã€‚
         */
        function renderAccuracyChart(bookAccuracy) {
            if (accuracyChartInstance) {
                accuracyChartInstance.destroy();
            }

            // è½‰æ›ç‚ºé™£åˆ—ï¼Œä¸¦æŒ‰æ­£ç¢ºç‡å‡åºæ’åˆ— (ä½åˆ†åœ¨å‰ï¼Œæ–¹ä¾¿æŸ¥çœ‹å¼±é»)
            const sortedEntries = Object.entries(bookAccuracy)
                .sort(([, a], [, b]) => a.accuracy - b.accuracy);

            const labels = sortedEntries.map(([book]) => book);
            const data = sortedEntries.map(([, data]) => parseFloat(data.accuracy.toFixed(1)));
            const colors = sortedEntries.map(([, data]) => data.color);

            accuracyChartInstance = new Chart(document.getElementById('accuracyBarChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ­£ç¢ºç‡ (%)',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // é¡¯ç¤ºç‚ºæ°´å¹³é•·æ¢åœ–
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'æ­£ç¢ºç‡ (%)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: 'ç« ç¯€æ­£ç¢ºç‡ (åˆ†æ•¸è¶Šä½è¶Šéœ€å„ªå…ˆåŠ å¼·)'
                        }
                    }
                }
            });
        }


        // --- ä¸»åŸ·è¡Œå‡½æ•¸ ---
        window.onload = function() {
            if (!quizResults || quizResults.length === 0) {
                document.getElementById('summary-section').innerHTML = '<p class="text-center text-xl text-red-500">âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ¸¬é©—çµæœæ•¸æ“šå¯ä¾›åˆ†æã€‚è«‹å…ˆå®Œæˆæ¸¬é©—ã€‚</p>';
                return;
            }

            // 1. åˆ†ææ•¸æ“š
            const summary = analyzeResults(quizResults);

            // 2. æ¸²æŸ“ç¸½çµ
            renderSummary(summary);

            // 3. æ¸²æŸ“è©³ç´°è¡¨æ ¼
            renderTable(summary.bookAccuracy);

            // 4. æ¸²æŸ“åœ“é¤…åœ–
            renderDistributionChart(summary.bookAccuracy);

            // 5. æ¸²æŸ“é•·æ¢åœ– (å¼±é»åˆ†æ)
            renderAccuracyChart(summary.bookAccuracy);
        };

    </script>
</body>
</html>
