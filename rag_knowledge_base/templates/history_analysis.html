{% extends "layout.html" %}

{% block content %}

<div class="container my-5">
    <style>
        .history-stat-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
    </style>

    <h1 class="text-center mb-4 text-primary">é¡Œåº«å…¨åŸŸéŒ¯èª¤åˆ†æ</h1>

    <!-- è¿”å›æ¸¬é©—æŒ‰éˆ• -->
    <div class="view-control text-center mb-4">
        <a href="/quiz" class="btn btn-outline-primary">â† è¿”å›æ¸¬é©—é é¢</a>
    </div>

    <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
    <div id="history-loading-spinner" class="text-center my-5">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">è¼‰å…¥ä¸­...</span></div>
        <p class="mt-2 text-muted">æ­£åœ¨è¼‰å…¥é¡Œåº«åˆ†ææ•¸æ“š...</p>
    </div>

    <!-- åˆ†æå…§å®¹ -->
    <div id="history-content" class="d-none">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">ğŸ”¥ æ˜“éŒ¯é¡Œ (å…¨åŸŸéŒ¯èª¤æ¬¡æ•¸å‰äº”å)</h4>
            </div>
            <div class="card-body" id="frequent-mistakes">
                <!-- æ•¸æ“šå°‡ç”± JS å¡«å…… -->
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-dark">
                <h4 class="mb-0">ğŸ“š æ˜“éŒ¯é¡å‹ (ä¾†æºæ›¸ç±å…¨åŸŸéŒ¯èª¤æ¬¡æ•¸çµ±è¨ˆ)</h4>
            </div>
            <div class="card-body" id="frequent-types">
                <!-- æ•¸æ“šå°‡ç”± JS å¡«å…… -->
            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- å¾å¾Œç«¯ (Flask/Jinja) è¼‰å…¥çš„ JSON é¡Œåº«æ•¸æ“š ---
    // å‡è¨­ Flask è·¯ç”±å·²å°‡ 'all_questions_with_tags.json' çš„å…§å®¹ä½œç‚º 'knowledge_base' è®Šæ•¸å‚³å…¥ã€‚
    const globalKnowledgeBase = {{ knowledge_base | tojson }};

    // --- Function to Fetch and Analyze History ---
    async function loadHistory() {
        const frequentMistakesDiv = document.getElementById('frequent-mistakes');
        const frequentTypesDiv = document.getElementById('frequent-types');
        const loadingSpinner = document.getElementById('history-loading-spinner');
        const historyContent = document.getElementById('history-content');

        // æª¢æŸ¥æ•¸æ“šæ˜¯å¦æœ‰æ•ˆ
        if (!globalKnowledgeBase || globalKnowledgeBase.length === 0) {
            loadingSpinner.classList.add('d-none');
            historyContent.classList.remove('d-none');
            frequentMistakesDiv.innerHTML = '<p class="text-danger">ç„¡æ³•è¼‰å…¥é¡Œåº«æ•¸æ“šæˆ–é¡Œåº«ç‚ºç©ºã€‚</p>';
            frequentTypesDiv.innerHTML = '<p class="text-danger">ç„¡æ³•è¼‰å…¥é¡Œåº«æ•¸æ“šæˆ–é¡Œåº«ç‚ºç©ºã€‚</p>';
            return;
        }

        // åˆå§‹åŒ–é¡¯ç¤º
        frequentMistakesDiv.innerHTML = '<p class="text-primary">æ­£åœ¨å¾é¡Œåº«æ•¸æ“šä¸­è¨ˆç®—...</p>';
        frequentTypesDiv.innerHTML = '<p class="text-primary">æ­£åœ¨å¾é¡Œåº«æ•¸æ“šä¸­è¨ˆç®—...</p>';

        // 1. è™•ç†æ˜“éŒ¯é¡Œ (æ ¹æ“š error_count æ’åº)
        const sortedMistakes = globalKnowledgeBase
            .filter(q => q.error_count > 0) // åªåˆ†ææœ‰éŒ¯èª¤æ¬¡æ•¸çš„é¡Œç›®
            .sort((a, b) => b.error_count - a.error_count) // æ ¹æ“š JSON ä¸­çš„ error_count é™åºæ’åˆ—
            .slice(0, 5); // åªå–å‰äº”å

        if (sortedMistakes.length === 0) {
            frequentMistakesDiv.innerHTML = '<p class="text-success">ç›®å‰æ‰€æœ‰é¡Œç›®å…¨åŸŸéŒ¯èª¤æ¬¡æ•¸å‡ç‚º 0ã€‚</p>';
        } else {
            frequentMistakesDiv.innerHTML = sortedMistakes.map((m, index) => `
                <div class="history-stat-item">
                    <p class="mb-1 fw-bold">ç¬¬ ${index + 1} åï¼š${m.é¡Œç›®}</p>
                    <p class="mb-0 text-danger">å…¨åŸŸéŒ¯èª¤æ¬¡æ•¸ï¼š${m.error_count}</p>
                    <p class="mb-0 text-muted">ä¾†æºï¼š${m.ä¾†æºæ›¸ç±}</p>
                </div>
            `).join('');
        }

        // 2. è™•ç†æ˜“éŒ¯é¡å‹ (ä¾†æºæ›¸ç±éŒ¯èª¤æ¬¡æ•¸çµ±è¨ˆ)
        const typeCounts = {};

        globalKnowledgeBase.forEach(question => {
            const typeKey = question['ä¾†æºæ›¸ç±'] || 'æœªåˆ†é¡';
            // å°‡æ‰€æœ‰å±¬æ–¼è©²ä¾†æºæ›¸ç±çš„ error_count ç´¯åŠ 
            const errors = question.error_count || 0; // ç¢ºä¿ error_count æœ‰å€¼
            typeCounts[typeKey] = (typeCounts[typeKey] || 0) + errors;
        });

        const sortedTypes = Object.entries(typeCounts)
            .filter(([, count]) => count > 0) // åªé¡¯ç¤ºæœ‰éŒ¯èª¤çš„é¡å‹
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5); // åªå–å‰äº”å

        if (sortedTypes.length === 0) {
            frequentTypesDiv.innerHTML = '<p class="text-success">ç›®å‰æ‰€æœ‰åˆ†é¡éŒ¯èª¤ç¸½æ¬¡æ•¸å‡ç‚º 0ã€‚</p>';
        } else {
            frequentTypesDiv.innerHTML = sortedTypes.map(([type, count], index) => `
                <div class="history-stat-item">
                    <p class="mb-1 fw-bold">ç¬¬ ${index + 1} åä¾†æºæ›¸ç±ï¼š${type}</p>
                    <p class="mb-0 text-danger">ç´¯ç©éŒ¯èª¤ç¸½æ¬¡æ•¸ï¼š${count}</p>
                </div>
            `).join('');
        }

        // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨ï¼Œé¡¯ç¤ºå…§å®¹
        loadingSpinner.classList.add('d-none');
        historyContent.classList.remove('d-none');
    }

    // é é¢è¼‰å…¥æ™‚å•Ÿå‹•åˆ†æ
    window.onload = loadHistory;
</script>


{% endblock %}